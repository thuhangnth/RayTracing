<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TH_RayTracing</title>
</head>
<body>
    <script src="http://www.comp.nus.edu.sg/~hugh/CS3211/js/decls.js?nocache"></script>
    <script src="http://www.comp.nus.edu.sg/~hugh/CS3211/js/gpu.js?nocache"></script>
    <script>
        var camera = [
            0,0,0,                     // x,y,z coordinates
            0,0,1,                     // Direction vector
            45                         // field of view : example 45
        ];

        var lights = [
            2,                         // number of lights
            200,200,200, 0,1,0,        // light 1, x,y,z location, and rgb colour (green)
            100,100,100, 1,1,1         // light 2, x,y,z location, and rgb colour (white)
        ];

        var objects = [
            3,                                                                             // number of objects
            ObjTyp.SPHERE,      13, 1.0,0.0,0.0,0.2,0.7,0.1,1.0, -20,10,100,10,           // typ,recsz,r,g,b,spec,lamb,amb,opac, x,y,z,rad,
            ObjTyp.SPHERE,      13, 0.0,0.0,1.0,0.2,0.7,0.1,1.0,  0 ,20,150,20,            // typ,recsz,r,g,b,spec,lamb,amb,opac, x,y,z,rad,
            ObjTyp.CYLINDER,    14, 1.0,0.0,0.0,0.2,0.7,0.1,1.0,  -80,-30,100,10,40
        ];

        var pi=22/7;
        var width_pixel = 800;  //Screen width in pixel unit
        var height_pixel = 600; //Screen height in pixel unit
        var ratio = width_pixel/height_pixel; //Ratio of screen width to screen height
        var camAngleRad=camera[6]*pi/180;
        var halfWidth = Math.tan(camAngleRad);  //screen half width in coordinate unit. ASSUMPTION: focal length = 1
        var width = halfWidth*2;
        var height = width/ratio;
        var halfHeight = height/2;
        var pixelWidth = width/width_pixel;    //width of a pixel
        var pixelHeight = height/height_pixel; //height of a pixel
        var halfPixelWidth = pixelWidth/2;
        var halfPixelHeight = pixelHeight/2;

        var gpu = new GPU();

        function dot(x1,y1,z1,x2,y2,z2)
        {
            return x1*x2 + y1*y2 + z1*z2;
        }

        function solveQuad(a,b,c)
        {
            var discriminant = b*b - 4*a*c;
            if(discriminant < 0)
            {
                return -1;
            }
            else
            {
                var sqrt = Math.sqrt(discriminant);
                var x1 = (-b + sqrt)/(2*a);
                var x2 = (-b - sqrt)/(2*a);
                if (x1<=x2)
                    return x1;
                else
                    return x2;
            }
        }

        gpu.addFunction(dot);
        gpu.addFunction(solveQuad);

        function doit(mode) {
            var opt = {
                dimensions: [800,600],
                debug: true,
                graphical: true,
                safeTextureReadHack: false,
                constants: { OBJCOUNT: objects[0],
                    EMPTY: ObjTyp.EMPTY,    SPHERE: ObjTyp.SPHERE,   CUBOID: ObjTyp.CUBOID,
                    CYLINDER: ObjTyp.CYLINDER,   CONE: ObjTyp.CONE,   TRIANGLE: ObjTyp.TRIANGLE },
                mode: mode
            };

            var y = gpu.createKernel(function(halfWidth,pixelWidth,halfPixelWidth,halfHeight,pixelHeight,halfPixelHeight,objects) {
                this.color(0.95,0.95,0.95);
                var ray_x= -halfWidth + this.thread.x * pixelWidth + halfPixelWidth; //map pixel to coord
                var ray_y= -halfHeight + this.thread.y * pixelHeight + halfPixelHeight; // map pixel to coords
                var ray_z= 1; // default: focal length = 1
                var length = Math.sqrt(ray_x*ray_x + ray_y*ray_y + ray_z*ray_z);
                var unit_ray_x = ray_x/length;
                var unit_ray_y = ray_y/length;
                var unit_ray_z = ray_z/length;
                var distance = 0;
                var minDist;
                var count = 1;
                var idx = 1;
                var nextidx = 1;
                for (i=0;i<this.constants.OBJCOUNT;i++)
                {
                    var hit = 0;
                    idx = nextidx;
                    nextidx = idx + objects[idx+1];
                    var obj_x = objects[idx + 9];
                    var obj_y = objects[idx + 10];
                    var obj_z = objects[idx + 11];
                    if (objects[idx]== this.constants.SPHERE) {
                        var v = dot(obj_x, obj_y, obj_z, unit_ray_x, unit_ray_y, unit_ray_z);
                        var c2 = dot(obj_x, obj_y, obj_z, obj_x, obj_y, obj_z);
                        var radius = objects[idx + 12];
                        var discriminant = radius * radius - c2 + v * v;
                        if (discriminant >= 0) {
                            hit = 1;
                            distance = v - Math.sqrt(discriminant);
                        }
                    }
                    if(objects[idx]== this.constants.CYLINDER)
                    {
                        var radius = objects[idx+12];
                        var height = objects[idx+13];
                        var a = (unit_ray_x*unit_ray_x)+(unit_ray_z*unit_ray_z);
                        var b = -(2*unit_ray_x*obj_x + 2*unit_ray_z*obj_z);
                        var c = (obj_x*obj_x)+(obj_z*obj_z)-radius*radius;
                        var t = solveQuad(a,b,c);
                        if(t>0)
                        {
                            if(t*unit_ray_y <= obj_y+height && t*unit_ray_y>=obj_y)
                            {
                                hit = 1;
                                distance = t*length;
                            }
                        }
                    }
                    if (hit == 1)
                    {
                        if (count == 1) minDist = distance;
                        count++;
                        if (distance <= minDist) {
                            this.color(objects[idx + 2], objects[idx + 3], objects[idx + 4]);
                        }
                    }
                }
            }, opt);
            return y;
        }

        var mykernel = doit("gpu");
        mykernel(halfWidth,pixelWidth,halfPixelWidth,halfHeight,pixelHeight,halfPixelHeight,objects);
        var canvas = mykernel.getCanvas();
        document.getElementsByTagName('body')[0].appendChild(canvas);
    </script>
    <canvas width="800" height="600"></canvas>
</body>
</html>